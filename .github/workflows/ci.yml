name: Autonomy CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq sqlite3
        pip install flask requests
    
    - name: Run tests
      run: |
        cd tests
        bash run_tests.sh || true
    
    - name: Check syntax
      run: |
        bash -n autonomy
        bash -n daemon.sh
        python3 -m py_compile web_ui.py
    
    - name: Validate JSON configs
      run: |
        jq empty config.json
        for f in tasks/*.json; do
          jq empty "$f" || echo "Invalid JSON: $f"
        done

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        severity: warning
        scandir: '.'
      continue-on-error: true

  security:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('trivy-results.sarif') != ''
      with:
        sarif_file: 'trivy-results.sarif'
        category: 'trivy'

  deploy-docs:
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate documentation
      run: |
        mkdir -p docs/generated
        echo "# Autonomy API Documentation" > docs/generated/api.md
        echo "Generated: $(date)" >> docs/generated/api.md
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
      continue-on-error: true
