#!/bin/bash
# Task Manager — Quick task operations

AUTONOMY_DIR="${AUTONOMY_DIR:-/root/.openclaw/workspace/skills/autonomy}"
TASKS_DIR="$AUTONOMY_DIR/tasks"

color() {
    case "$1" in
        green) echo '\033[0;32m' ;;
        red) echo '\033[0;31m' ;;
        yellow) echo '\033[1;33m' ;;
        blue) echo '\033[0;34m' ;;
        gray) echo '\033[0;90m' ;;
        reset) echo '\033[0m' ;;
    esac
}

task_list() {
    printf "$(color blue)═══ Active Tasks ═══$(color reset)\n\n"
    
    for task_file in "$TASKS_DIR"/*.json; do
        [[ -f "$task_file" ]] || continue
        
        local name status completed priority
        name=$(jq -r '.name' "$task_file" 2>/dev/null)
        status=$(jq -r '.status' "$task_file" 2>/dev/null)
        completed=$(jq -r '.completed' "$task_file" 2>/dev/null)
        priority=$(jq -r '.priority // "normal"' "$task_file" 2>/dev/null)
        
        local color="$(color reset)"
        [[ "$completed" == "true" ]] && color="$(color gray)"
        [[ "$status" == "needs_ai_attention" ]] && color="$(color yellow)"
        [[ "$status" == "ai_processing" ]] && color="$(color blue)"
        [[ "$priority" == "high" ]] && [[ "$completed" != "true" ]] && color="$(color red)"
        
        printf "${color}• %-30s [%s] (%s)$(color reset)\n" "$name" "$status" "$priority"
    done
    
    local total=$(find "$TASKS_DIR" -name "*.json" | wc -l)
    printf "\n$(color gray)Total: %d tasks$(color reset)\n" "$total"
}

task_show() {
    local name="$1"
    [[ -z "$name" ]] && { echo "Usage: task show <name>"; exit 1; }
    
    local task_file="$TASKS_DIR/${name}.json"
    [[ -f "$task_file" ]] || { echo "Task not found: $name"; exit 1; }
    
    jq . "$task_file"
}

task_quick() {
    local desc="$*"
    [[ -z "$desc" ]] && { echo "Usage: task quick <description>"; exit 1; }
    
    autonomy work "$desc"
}

task_done() {
    local name="$1"
    local proof="${2:-"Completed"}"
    
    [[ -z "$name" ]] && { echo "Usage: task done <name> [proof]"; exit 1; }
    
    autonomy task complete "$name" "$proof"
}

task_clean() {
    echo "Cleaning completed tasks..."
    
    for task_file in "$TASKS_DIR"/*.json; do
        [[ -f "$task_file" ]] || continue
        
        local completed
        completed=$(jq -r '.completed' "$task_file" 2>/dev/null)
        
        if [[ "$completed" == "true" ]]; then
            local name=$(basename "$task_file" .json)
            mkdir -p "$TASKS_DIR/completed"
            mv "$task_file" "$TASKS_DIR/completed/"
            echo "  Archived: $name"
        fi
    done
    
    echo "✓ Cleanup complete"
}

case "${1:-list}" in
    list|ls)
        task_list
        ;;
    show|view)
        shift
        task_show "$@"
        ;;
    quick|q)
        shift
        task_quick "$@"
        ;;
    done|complete)
        shift
        task_done "$@"
        ;;
    clean|archive)
        task_clean
        ;;
    *)
        echo "Task Manager"
        echo "Usage: task <command> [args]"
        echo ""
        echo "Commands:"
        echo "  list (ls)           — List active tasks"
        echo "  show <name>         — Show task details"
        echo "  quick <desc>        — Quick create task"
        echo "  done <name> [proof] — Mark task complete"
        echo "  clean               — Archive completed tasks"
        ;;
esac
