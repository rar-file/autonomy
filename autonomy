#!/bin/bash
# Autonomy CLI - Enhanced with smart actions
# Usage: autonomy [command] [args]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE="/root/.openclaw/workspace"
AUTONOMY_DIR="$WORKSPACE/skills/autonomy"
CONFIG="$AUTONOMY_DIR/config.json"
CONTEXTS_DIR="$AUTONOMY_DIR/contexts"
HEARTBEAT="$WORKSPACE/HEARTBEAT.md"
HEARTBEAT_DISABLED="$WORKSPACE/HEARTBEAT.md.disabled"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat << EOF
Autonomy - Context-aware intelligent automation

Commands:
  status                    Show current autonomy state
  on [context]              Enable autonomy (optionally for specific context)
  off                       Disable autonomy
  
  context list              List all contexts
  context add <name> <path>  Add a new context
  context remove <name>     Remove a context
  context switch <name>     Switch to a context (alias for 'on')
  
  check now                 Run checks immediately
  check <name>              Run specific check
  
  action stash <repo>       Smart stash with message
  action commit <repo>      Quick commit with generated message
  action push <repo>        Push current branch
  action sync <repo>        Sync with remote (ff-only)
  
  insights                  Show what autonomy has learned
  config                    Show/edit configuration
  
  help                      Show this help

Examples:
  autonomy on git-aware           # Enable git monitoring
  autonomy action commit .        # Quick commit in current dir
  autonomy context add myapp ~/myapp  # Add new project context
EOF
}

cmd_status() {
    if [[ -f "$HEARTBEAT" ]]; then
        ACTIVE=$(jq -r '.active_context // "none"' "$CONFIG")
        echo -e "${GREEN}●${NC} Autonomy: ENABLED"
        echo "   Active context: $ACTIVE"
        
        # Show smart status
        if [[ "$ACTIVE" != "null" && -n "$ACTIVE" ]]; then
            CONTEXT_FILE="$CONTEXTS_DIR/${ACTIVE}.json"
            if [[ -f "$CONTEXT_FILE" ]]; then
                DESC=$(jq -r '.description // "No description"' "$CONTEXT_FILE")
                echo "   Description: $DESC"
                
                # Show last check time if available
                LAST_CHECK=$(jq -r '.last_check // "never"' "$CONTEXT_FILE")
                if [[ "$LAST_CHECK" != "never" ]]; then
                    echo "   Last check: $LAST_CHECK"
                fi
            fi
        fi
    else
        echo -e "${RED}○${NC} Autonomy: DISABLED"
        echo "   Run 'autonomy on' to enable"
    fi
    
    echo ""
    echo "Available contexts:"
    for ctx_file in "$CONTEXTS_DIR"/*.json; do
        [[ -f "$ctx_file" ]] || continue
        name=$(basename "$ctx_file" .json)
        [[ "$name" == example-* ]] && continue
        
        desc=$(jq -r '.description // "No description"' "$ctx_file" 2>/dev/null)
        echo "   • $name: $desc"
    done
}

cmd_on() {
    CONTEXT="${1:-default}"
    CONTEXT_FILE="$CONTEXTS_DIR/${CONTEXT}.json"
    
    if [[ ! -f "$CONTEXT_FILE" ]]; then
        echo -e "${RED}Error:${NC} Context '$CONTEXT' not found."
        echo "Create it with: autonomy context add $CONTEXT <path>"
        return 1
    fi
    
    # Enable heartbeat
    if [[ -f "$HEARTBEAT_DISABLED" ]]; then
        mv "$HEARTBEAT_DISABLED" "$HEARTBEAT"
    fi
    
    # Update config
    jq --arg ctx "$CONTEXT" --arg time "$(date -Iseconds)" \
       '.active_context = $ctx | .last_activated = $time' "$CONFIG" > "${CONFIG}.tmp"
    mv "${CONFIG}.tmp" "$CONFIG"
    
    echo -e "${GREEN}✓${NC} Autonomy ENABLED"
    echo "   Context: $CONTEXT"
    
    # Show context-specific info
    TYPE=$(jq -r '.type // "standard"' "$CONTEXT_FILE")
    if [[ "$TYPE" == "smart" ]]; then
        echo "   Type: Smart (adaptive)"
        CHECKS=$(jq -r '.checks | length' "$CONTEXT_FILE")
        echo "   Checks: $CHECKS active"
    fi
    
    # Run first check immediately in background
    ($0 check now >/dev/null 2>&1 &)
}

cmd_off() {
    # Get current context for summary
    ACTIVE=$(jq -r '.active_context // "none"' "$CONFIG")
    
    # Disable heartbeat
    if [[ -f "$HEARTBEAT" ]]; then
        mv "$HEARTBEAT" "$HEARTBEAT_DISABLED"
    fi
    
    # Update config
    jq --arg time "$(date -Iseconds)" \
       '.active_context = null | .last_deactivated = $time' "$CONFIG" > "${CONFIG}.tmp"
    mv "${CONFIG}.tmp" "$CONFIG"
    
    echo -e "${RED}○${NC} Autonomy DISABLED"
    [[ "$ACTIVE" != "null" ]] && echo "   Was monitoring: $ACTIVE"
}

cmd_context() {
    SUBCMD="${1:-list}"
    
    case "$SUBCMD" in
        list)
            echo "Available contexts:"
            for ctx_file in "$CONTEXTS_DIR"/*.json; do
                [[ -f "$ctx_file" ]] || continue
                name=$(basename "$ctx_file" .json)
                [[ "$name" == example-* ]] && continue
                
                desc=$(jq -r '.description // "No description"' "$ctx_file" 2>/dev/null)
                type=$(jq -r '.type // "standard"' "$ctx_file" 2>/dev/null)
                type_label=""
                [[ "$type" == "smart" ]] && type_label=" [smart]"
                
                echo "   • $name$type_label: $desc"
            done
            ;;
            
        add)
            NAME="$2"
            PATH_TARGET="$3"
            
            if [[ -z "$NAME" || -z "$PATH_TARGET" ]]; then
                echo "Usage: autonomy context add <name> <path>"
                return 1
            fi
            
            # Expand path
            PATH_TARGET="${PATH_TARGET/#\~/$HOME}"
            
            if [[ ! -d "$PATH_TARGET" ]]; then
                echo -e "${YELLOW}Warning:${NC} Path doesn't exist yet: $PATH_TARGET"
            fi
            
            # Auto-detect project type
            PROJECT_TYPE="general"
            [[ -f "$PATH_TARGET/package.json" ]] && PROJECT_TYPE="node"
            [[ -f "$PATH_TARGET/requirements.txt" ]] && PROJECT_TYPE="python"
            [[ -f "$PATH_TARGET/Cargo.toml" ]] && PROJECT_TYPE="rust"
            [[ -d "$PATH_TARGET/.git" ]] && PROJECT_TYPE="git"
            
            cat > "$CONTEXTS_DIR/${NAME}.json" << EOF
{
  "name": "$NAME",
  "path": "$PATH_TARGET",
  "description": "$PROJECT_TYPE project context",
  "created": "$(date -Iseconds)",
  "type": "smart",
  "checks": [
    "git_status",
    "file_integrity"
  ],
  "goals": [],
  "alerts": {
    "on_error": true,
    "on_change": false
  },
  "auto_detected_type": "$PROJECT_TYPE"
}
EOF
            echo -e "${GREEN}✓${NC} Context '$NAME' created"
            echo "   Path: $PATH_TARGET"
            echo "   Type: $PROJECT_TYPE"
            ;;
            
        remove)
            NAME="$2"
            if [[ -z "$NAME" ]]; then
                echo "Usage: autonomy context remove <name>"
                return 1
            fi
            rm "$CONTEXTS_DIR/${NAME}.json"
            echo -e "${GREEN}✓${NC} Context '$NAME' removed"
            ;;
            
        switch)
            # Alias for 'on'
            cmd_on "$2"
            ;;
            
        *)
            echo "Unknown context command: $SUBCMD"
            echo "Usage: autonomy context {list|add|remove|switch}"
            return 1
            ;;
    esac
}

cmd_action() {
    ACTION="$1"
    TARGET="$2"
    
    case "$ACTION" in
        stash|commit|push|sync)
            if [[ -z "$TARGET" ]]; then
                echo "Usage: autonomy action $ACTION <repo-path>"
                return 1
            fi
            TARGET="${TARGET/#\~/$HOME}"
            "$AUTONOMY_DIR/actions.sh" "$ACTION" "$TARGET"
            ;;
        *)
            echo "Unknown action: $ACTION"
            echo "Actions: stash, commit, push, sync"
            return 1
            ;;
    esac
}

cmd_insights() {
    echo "Autonomy Insights"
    echo "================="
    echo ""
    
    # Check action log
    if [[ -f "$AUTONOMY_DIR/logs/actions.jsonl" ]]; then
        echo "Recent actions:"
        tail -10 "$AUTONOMY_DIR/logs/actions.jsonl" | while read line; do
            action=$(echo "$line" | jq -r '.action')
            target=$(echo "$line" | jq -r '.target')
            msg=$(echo "$line" | jq -r '.message')
            echo "   • $action: $msg"
        done
    else
        echo "No actions recorded yet."
    fi
    
    echo ""
    echo "Pattern detection:"
    echo "   (Learning mode will track your patterns here)"
}

# Main dispatch
case "${1:-status}" in
    status)
        cmd_status
        ;;
    on)
        shift
        cmd_on "$@"
        ;;
    off)
        cmd_off
        ;;
    context)
        shift
        cmd_context "$@"
        ;;
    action)
        shift
        cmd_action "$@"
        ;;
    insights)
        cmd_insights
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'autonomy help' for usage"
        exit 1
        ;;
esac
